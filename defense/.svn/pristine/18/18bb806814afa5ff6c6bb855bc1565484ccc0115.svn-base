<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.yagout.defense.dal.service.UserLogAndTypeMapper">
	<resultMap id="BaseResultMap" type="com.yagout.defense.dal.model.UserLogAndType">
		<!-- WARNING - @mbggenerated This element is automatically generated by 
			MyBatis Generator, do not modify. -->
		<id column="id" property="id" jdbcType="BIGINT" />  
		<result column="user_id" property="userId" jdbcType="INTEGER" />
        <result column="user_name" property="userName" jdbcType="VARCHAR" />
        <result column="event_type" property="eventType" jdbcType="INTEGER" />
		<result column="type_name" property="typeName" jdbcType="VARCHAR" />
		<result column="event_time" property="eventTime" jdbcType="TIMESTAMP" />
		<result column="event_result" property="eventResult" jdbcType="INTEGER" />
	</resultMap>
	
	<select id="getByMap" parameterType="java.util.Map" resultMap="BaseResultMap">
		SELECT ul.id as id,
		       ul.user_id as user_id,
		       u.user_name as user_name,
		       ul.event_type as event_type,
		       ulet.type_name as type_name,
		       ul.event_time as event_time,
		       ul.event_result as event_result
		FROM user_log ul
		LEFT JOIN user u ON u.user_id=ul.user_id
		LEFT JOIN user_log_event_type ulet ON ul.event_type=ulet.event_type
	    WHERE 1=1
		<if test="userId != null">
		  AND ul.user_id = #{userId,jdbcType=INTEGER}
		</if>
		<if test="beginEventTime != null and beginEventTime !='' 
		          and endEventTime == null and endEventTime =='' ">
		  <![CDATA[AND TIMESTAMPDIFF(SECOND,ul.event_time,
		              DATE_FORMAT(#{beginEventTime,jdbcType=VARCHAR},'%Y-%m-%d %h:%i:%s'))<= 0]]>
		</if>
		<if test="beginEventTime == null and beginEventTime =='' 
		          and endEventTime != null and endEventTime !='' ">
		  <![CDATA[AND TIMESTAMPDIFF(SECOND,ul.event_time,
		              DATE_FORMAT(#{endEventTime,jdbcType=VARCHAR},'%Y-%m-%d %h:%i:%s'))>= 0]]>  
		</if>	
		<if test="beginEventTime != null and beginEventTime !='' 
		          and endEventTime != null and endEventTime !='' ">
		  AND ul.event_time BETWEEN DATE_FORMAT(#{beginEventTime,jdbcType=VARCHAR},'%Y-%m-%d %h:%i:%s') 
                AND DATE_FORMAT(#{endEventTime,jdbcType=VARCHAR},'%Y-%m-%d %h:%i:%s')       
		</if>	
		<if test="eventType != null and eventType !='' ">
	      AND ul.event_type = #{eventType,jdbcType=INTEGER}
		</if>
		<if test="eventResult != null">
		  AND ul.event_result = #{eventResult,jdbcType=INTEGER}
		</if>
		<if test="sidx != null">
		  ORDER BY ul.event_time ${sord}
		</if>
	</select>
</mapper>